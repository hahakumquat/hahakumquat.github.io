window.onload=function(){function e(){l=new THREE.Scene,s=new THREE.PerspectiveCamera(30,p/E,1,2*p),s.position.z=p,l.add(s),m=a(C[B]),t(new THREE.PlaneGeometry(y-4,y-4)),u=new THREE.WebGLRenderer,u.setSize(p,E),document.getElementById("container").appendChild(u.domElement),document.addEventListener("mousemove",r,!1),document.body.onkeyup=function(e){if(32==e.keyCode){var n;n=P?new THREE.SphereGeometry(y/1.8,15):new THREE.PlaneGeometry(y-4,y-4),t(n),P=!P}},document.addEventListener("click",function(e){d(f,C[++B%C.length]),m.needsUpdate=!0,r(e,!0)},!1),h()}function t(e){w.forEach(function(e){l.remove(e)}),w=[];for(var t=0;t<g;t++)for(var n=0;n<x;n++){mat=new THREE.ShaderMaterial({uniforms:{texture:{type:"t",value:m},rotation:{type:"f",value:0}},vertexShader:document.getElementById("vertexshader").textContent,fragmentShader:document.getElementById("fragmentshader").textContent,side:THREE.DoubleSide});var a=new THREE.Mesh(e,mat);a.position.setX((n-(x-1)/2)*y),a.position.setY(Math.floor(g/2-t)*y),a.rotation.x=Math.PI,a.row=t,a.col=n,a.ripple=-1,a.adjacents=o(t,n),l.add(a),w.push(a)}}function n(e){var t=1,n=setInterval(function(){t<=.01&&(clearInterval(n),e.style.display="none"),e.style.opacity=t,e.style.filter="alpha(opacity="+100*t+")",t*=.9},50)}function a(e){var t=document.createElement("canvas");t.height=256,t.width=256,f=t.getContext("2d"),d(f,e);var n=new THREE.Texture(t);return n.needsUpdate=!0,n}function o(e,t){var n=[];return e>0&&(t>0&&n.push([e-1,t-1]),t<x-1&&n.push([e-1,t+1])),e<g-1&&(t>0&&n.push([e+1,t-1]),t<x-1&&n.push([e+1,t+1])),e>0&&n.push([e-1,t]),e<g-1&&n.push([e+1,t]),t>0&&n.push([e,t-1]),t<x-1&&n.push([e,t+1]),n}function r(e,t){M.x=e.clientX/p*2-1,M.y=e.clientY/E*-2+1,R.setFromCamera(M,s);var n=R.intersectObjects(w);if(n.length>0){var a=n[0].object;t||B%4==2?c([a],j):i(a)}else t&&c([w[Math.floor(w.length*Math.random())]],j)}function i(e){e.adjacents.forEach(function(e,t){var n=w[e[0]*x+e[1]];n.adjacents.forEach(function(e,t){var n=w[e[0]*x+e[1]];n.rotation.x+=t<4?.2:.1}),n.rotation.x+=t<4?.5:.3})}function c(e,t){for(var n=B%4;t>0;){for(var a=0,o=e.length;a<o;a++){var r=e.shift();r.ripple<0&&(r.ripple=2*(j-t),r.adjacents.forEach(function(a){var o=w[a[0]*x+a[1]];switch(n){case 0:a[0]!==r.row&&a[1]!==r.col||e.push(o);break;case 1:a[0]!==r.row&&a[1]!==r.col&&e.push(o);break;case 2:Math.random()>1-t/80&&e.push(o);break;case 3:e.push(o)}}))}t--}}function d(e,t){for(var n=e.createLinearGradient(0,256,0,0),a=0,o=t.length-1;a<o;a++)n.addColorStop(a/o,t[a]);return n.addColorStop(1,t[t.length-1]),e.fillStyle=n,e.fillRect(0,0,256,256),n}function h(){requestAnimationFrame(h),w.forEach(function(e,t){e.rotation.x>.05?e.rotation.x/=1.1:e.rotation.x=0,0==e.ripple&&(e.rotation.x=Math.PI-2+2*Math.random()),e.ripple>=0&&e.ripple--,e.material.uniforms.rotation.value=e.rotation.x,e.position.z=Math.min(s.position.z/3,e.rotation.x/Math.PI*p/8)+10*Math.sin((Date.now()-b)/300+t/2)}),u.render(l,s)}window.setTimeout(function(){n(document.getElementById("title")),n(document.getElementById("info"))},4e3);var l,s,u;document.getElementById("container").setAttribute("style","width:90%"),document.getElementById("container").setAttribute("style","height:90%");var f,m,p=document.getElementById("container").offsetWidth,E=window.innerHeight,w=[],v=30,y=p/v,g=Math.ceil(v*E/p),x=v,b=Date.now(),M={},R=new THREE.Raycaster,k=["black","#771122","red","#ffeeee","white","#ff7777","white"],I=["black","#250101","#370000","#aa4400","white","orange","white","#eeee33","white"],T=["black","#007733","white","#11ff33","white"],H=["black","#003377","white","#00ffff","white"],S=["black","#662233","magenta","white","pink","pink","white"],C=[k,I,T,H,S],B=Math.floor(Math.random()*C.length),j=30,P=!0;e()};