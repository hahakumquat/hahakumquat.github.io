function shift(t){return t>3&&t--,t>5&&t--,t>9&&t--,t>11&&t--,t>39&&t--,t>47&&t--,t-1}var countyById=d3.map(),stateById=d3.map(),NUMCOLORS=9,mappedStates=["WA","ID","MT","ND","MN","ME","MI","WI","OR","SD","NH","VT","NY","WY","IA","NE","MA","IL","PA","CT","RI","CA","UT","NV","OH","IN","NJ","CO","WV","MO","KS","DE","MD","VA","KY","AZ","OK","NM","TN","NC","TX","AR","SC","AL","GA","MS","LA","FL","HI","AK"],sortedStates=["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NI","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"],states={WA:"Washington",ID:"Idaho",MT:"Montana",ND:"North Dakota",MN:"Minnesota",ME:"Maine",MI:"Michigan",WI:"Wisconsin",OR:"Oregon",SD:"South Dakota",NH:"New Hampshire",VT:"Vermont",NY:"New York",WY:"Wyoming",IA:"Iowa",NE:"Nebraska",MA:"Massachusetts",IL:"Illinois",PA:"Pennsylvania",CT:"Connecticut",RI:"Rhode Island",CA:"California",UT:"Utah",NV:"Nevada",OH:"Ohio",IN:"Indiana",NJ:"New Jersey",CO:"Colorado",WV:"West Virginia",MO:"Missouri",KS:"Kansas",DE:"Delaware",MD:"Maryland",VA:"Virginia",KY:"Kentucky",AZ:"Arizona",OK:"Oklahoma",NM:"New Mexico",TN:"Tennessee",NC:"North Carolina",TX:"Texas",AR:"Arkansas",SC:"South Carolina",AL:"Alabama",GA:"Georgia",MS:"Mississippi",LA:"Louisiana",FL:"Florida",HI:"Hawaii",AK:"Alaska"};Choropleth=function(t){var a=this;a.mapData=t,a.log=d3.scale.log().base(2).range([0,NUMCOLORS]),a.linear=d3.scale.linear().range([0,NUMCOLORS]),a.quantize=d3.scale.quantize().domain([0,NUMCOLORS]).range(d3.range(NUMCOLORS-1).map(function(t){return colorbrewer.Blues[NUMCOLORS][t]})),a.projection=d3.geo.albersUsa().scale(950).translate([350,250]),a.path=d3.geo.path().projection(a.projection),a.maxTotalCounty=0,a.maxGroundCounty=0,a.maxSurfaceCounty=0,a.maxTotalState=0,a.maxGroundState=0,a.maxSurfaceState=0,a.tip=d3.tip().attr("class","d3-tip").offset([0,10])},Choropleth.prototype.initVis=function(){var t=this;t.tip.html(function(t){var a,e,o=$("form.region input:radio:checked").val();if("states"===o){if(a=stateById.get(shift(t.id)),e='<p id="tips"><h5 id="tiptitle">'+states[a.state]+"</h5>",a.sumTotal<=0)return e+"<br>No Data.";e+="<br>Total (Mgal/d): "+a.sumTotal,e+="<br>Ground (Mgal/d): "+a.sumGround,e+="<br>Surface (Mgal/d): "+a.sumSurface,e+="</p>"}else{if(a=countyById.get(t.id),e='<p id="tips"><h5 id="tiptitle">'+a.name+", "+a.state+"</h5>",a[TOTALWATER]<=0)return e+"<br>No Data.";e+="<br>Total (Mgal/d): "+a[TOTALWATER],e+="<br>Ground (Mgal/d): "+a[TOTALGROUND],e+="<br>Surface (Mgal/d): "+a[TOTALSURFACE],e+="</p>"}return e}),t.svg.call(t.tip),t.leg=t.svg.append("g").attr("class","legend").attr("transform","translate("+(t.width-3*t.margin.left)+", "+t.height/2+")"),t.leg.append("text").attr("text-anchor","end").attr("fill","black").text("Mgal/day"),$("#choropleth").append("<h4>A Map of Water Consumption</h4><p>Take a look at water consumption by ground water and surface water across the US by cities and counties. The darker the blue, the more water is consumed in that region. As expected, water consumption is highest in places with high populations, especially in California. It is our job to tackle these high-consumptive areas to reduce the water burden.</p>"),t.updateVis()},Choropleth.prototype.wrangleData=function(){var t=this;t.filteredData=t.data[$("select.year option:selected").val()],t.filteredData.states.forEach(function(a,e){var o=0,r=0,n=0;a.counties.forEach(function(a){o+=a[TOTALWATER],r+=a[TOTALGROUND],n+=a[TOTALSURFACE],countyById.set(+a.fips,a),t.maxTotalCounty<a[TOTALWATER]&&(t.maxTotalCounty=a[TOTALWATER]),t.maxGroundCounty<a[TOTALGROUND]&&(t.maxGroundCounty=a[TOTALGROUND]),t.maxSurfaceCounty<a[TOTALSURFACE]&&(t.maxSurfaceCounty=a[TOTALSURFACE])}),a.sumGround=Math.round(r),a.sumSurface=Math.round(n),a.sumTotal=Math.round(o),stateById.set(e,a),t.maxTotalState<o&&(t.maxTotalState=o),t.maxGroundState<r&&(t.maxGroundState=r),t.maxSurfaceState<n&&(t.maxSurfaceState=n)})},Choropleth.prototype.updateVis=function(){var t=this,a=$("form.region input:radio:checked").val();if(t.wrangleData(),"counties"===a){var e=t.log;2==$("form.water-type input:checkbox:checked").length?e.domain([1,t.maxTotalCounty]):"gw"==$("form.water-type input:checkbox:checked").val()?e.domain([1,t.maxGroundCounty]):e.domain([1,t.maxSurfaceCounty])}else{var e=t.linear;2==$("form.water-type input:checkbox:checked").length?e.domain([1,t.maxTotalState]):"gw"==$("form.water-type input:checkbox:checked").val()?e.domain([1,t.maxGroundState]):e.domain([1,t.maxSurfaceState])}t.leg.selectAll("g").remove();for(var o=1;o<=NUMCOLORS;o++)gr=t.leg.append("g").attr("transform","translate(0, "+15*o+")"),gr.append("rect").attr("width","13px").attr("height","13px").attr("stroke","gray").attr("fill",colorbrewer.Blues[NUMCOLORS][NUMCOLORS-o]),gr.append("text").attr("fill","black").attr("text-anchor","end").attr("transform","translate(-2, 13)").text(Math.round(e.domain()[1]/NUMCOLORS*(NUMCOLORS-o))+"+");regionChanged&&(t.svg.selectAll(".region").remove(),regionChanged=!1);var r=t.svg.selectAll(".region").data(topojson.feature(t.mapData,t.mapData.objects[a]).features);r.enter().append("g").attr("class","region").append("path").attr("d",t.path).style("stroke","red").style("stroke-opacity",0).style("stroke-width",2).on("mouseover",function(a){d3.select(this.parentNode.appendChild(this)).transition().duration(300).style("stroke-opacity",1),t.tip.show(a)}).on("mouseout",function(a){d3.select(this.parentNode.appendChild(this)).transition().duration(300).style("stroke-opacity",0),t.tip.hide(a)}).on("click",function(t){"counties"===a?triggerUpdates(countyById.get(t.id)):triggerUpdates(stateById.get(shift(t.id)))}),r.transition().duration(700).style("fill",function(o){return"counties"===a?countyById.get(o.id)===undefined?"red":countyById.get(o.id)[TOTALWATER]<=0?"darkgray":t.quantize(e(+countyById.get(o.id)[TOTALWATER])):(id=shift(o.id),stateById.get(id)===undefined?"red":stateById.get(id).sumTotal<=0?"darkgray":t.quantize(e(+stateById.get(id).sumTotal)))}),r.exit().remove()};