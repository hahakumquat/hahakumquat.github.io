var IRRIGATIONFRESH="IRWFrTo",THERMOELECTRICTOTAL="PTWtotl",PUBLICSUPPLYTOTAL="PSWtotl",DOMESTICTOTAL="DOTOTAL",INDUSTRIALTOTAL="INWtotl",LIVESTOCKTOTAL="LIWFrTo",MININGTOTAL="MIWtotl",THERMOCIRCTOTAL="PCWTotl",industries=[THERMOCIRCTOTAL,PUBLICSUPPLYTOTAL,IRRIGATIONFRESH,DOMESTICTOTAL,THERMOELECTRICTOTAL,INDUSTRIALTOTAL,LIVESTOCKTOTAL,MININGTOTAL],indKey={IRWFrTo:"Irrigation (Freshwater) Withdrawals",PTWtotl:"Thermoelectric (Total) Withdrawals",PSWtotl:"Public Supply (Total) Withdrawals",DOTOTAL:"Domestic (Total) Withdrawals",INWtotl:"Industrial (Total) Withdrawals",LIWFrTo:"Livestock (Total) Withdrawals",MIWtotl:"Mining (Total) Withdrawals",PCWTotl:"Thermoelectric Circulation (Total) WIthdrawals"},colorScale=d3.scale.ordinal().range(["#b3e0ff","#66c2ff","#008ae6","#005c99","#003d66","#001f33","000000"].reverse()),parseDate=d3.time.format("%Y").parse,yrs;StackedAreaChart=function(){this.displayData=[],this.margin=margin},StackedAreaChart.prototype.initVis=function(){var t=this;yrs=t.data.map(function(t){return parseDate(t.year.toString())}),colorScale.domain(yrs),t.xScale=d3.time.scale().range([0,t.width-4*t.margin.left]).domain(d3.extent(yrs,function(t){return t})),t.yScale=d3.scale.linear().range([t.height,3.5*t.margin.top]),t.xAxis=d3.svg.axis().scale(t.xScale).orient("bottom").ticks(5),t.yAxis=d3.svg.axis().scale(t.yScale).orient("left"),t.svg.append("g").attr("class","axis x-axis").attr("transform","translate("+4*t.margin.left+", "+t.height+")"),t.svg.append("g").attr("class","axis y-axis").attr("transform","translate("+4*t.margin.left+", 0)"),t.svg.append("text").attr("class","error").attr("font-size","25px").attr("transform","translate("+(10+t.width/2+t.margin.left)+", "+2*t.height/3+")").attr("visibility","hidden").attr("text-anchor","middle").text("No Data"),t.svg.append("text").attr("id","region-name").attr("font-size","14px").attr("text-anchor","middle").attr("transform","translate("+(t.width/2+t.margin.left)+", "+t.margin.top+")").text(""),t.svg.append("text").attr("font-size","11px").attr("transform","rotate(-90), translate("+(-t.height+t.margin.top/2+t.margin.left)+", "+t.margin.top+")").text("Withdrawals (Mgal/day)"),t.svg.append("text").attr("font-size","11px").attr("transform","translate("+t.width/2+", "+(t.height+2*t.margin.bottom)+")").text("Year"),t.svg.append("text").attr("id","region-info").attr("font-size","14px").attr("text-anchor","middle").attr("transform","translate("+(t.width/2+t.margin.left)+", "+2*t.margin.top+")").text(""),t.dataCategories=colorScale.domain(),t.stack=d3.layout.stack().values(function(t){return t.values}),t.area=d3.svg.area().x(function(a){return t.xScale(a.x)}).y0(function(a){return t.yScale(a.y0)}).y1(function(a){return t.yScale(a.y0+a.y)}),t.svg.select(".x-axis").transition().call(t.xAxis),t.svg.select(".y-axis").transition().call(t.yAxis)},StackedAreaChart.prototype.wrangleData=function(t){var a=this,e=$("form.region input:radio:checked").val();a.transposedData=new Array;for(var r=0;r<industries.length;r++)a.transposedData.push({name:industries[r],values:[]});"counties"===e?($("#region-name").html(t.name+" Water Consumption Breakdown"),a.data.forEach(function(e){industries.forEach(function(r,i){var n={};n.x=parseDate(e.year.toString()),n.y=e.states[sortedStates.indexOf(t.state)].counties.filter(function(a){return a.name==t.name}),0==n.y.length?n.y=0:n.y=+n.y[0][r],a.transposedData[i].values.push(n)})})):($("#region-name").html(states[t.state]),a.data.forEach(function(e){industries.forEach(function(r,i){var n={},s=0;n.x=parseDate(e.year.toString()),e.states[sortedStates.indexOf(t.state)].counties.forEach(function(t){s+=t[r]}),n.y=s,a.transposedData[i].values.push(n)})}))},StackedAreaChart.prototype.updateVis=function(t){var a=this;if(a.wrangleData(t),a.displayData=a.stack(a.transposedData),a.isEmpty(a.displayData)){$("#region-info").html("");a.svg.select(".error").attr("visibility","visible");a.svg.selectAll(".area").remove()}else{a.svg.select(".error").attr("visibility","hidden"),a.yScale.domain([0,d3.max(a.displayData,function(t){return d3.max(t.values,function(t){return+(t.y0+t.y)})})]);var e=a.svg.selectAll(".area").data(a.displayData);$("#region-info").html(""),e.enter().append("path").attr("class","area").attr("transform","translate("+4*a.margin.left+", 0)"),e.style("fill",function(t){return colorScale(t.name)}).attr("d",function(t){return a.area(t.values)}).attr("stroke","#DDD").attr("stroke-opacity","0").attr("stroke-width","4px").on("mouseover",function(){d3.select(this).transition().attr("stroke-opacity",1)}).on("mouseout",function(t){$("#region-info").html()!==indKey[t.name]&&d3.select(this).transition().attr("stroke-opacity",0)}).on("click",function(t){d3.selectAll(".area").transition().attr("stroke-opacity","0"),$("#region-info").html(indKey[t.name]),d3.select(this).transition().attr("stroke-opacity","1")}),e.exit().remove(),a.svg.select(".x-axis").transition().call(a.xAxis),a.svg.select(".y-axis").transition().call(a.yAxis)}},StackedAreaChart.prototype.isEmpty=function(t){vis=this;var a=!0;return t.forEach(function(t){t.values.forEach(function(t){if(t.y>0)return a=!1,!1})}),a};